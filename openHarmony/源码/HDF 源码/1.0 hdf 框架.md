

hdf 驱动源码框架
```
hcf 文件中， moduleName是驱动模块的唯一标识，与驱动代码中的 HdfDriverEntry 的moduleName 对应
serviceName：驱动对外提供的服务名，其他组件通过这个来访问驱动。
deviceMatchAttr： 用于匹配在别的地方配置的hcs文件中的数据

HDF驱动加载流程：
1、编写驱动代码 和使用HDF_INIT 注册
2、编写HCS 配置文件 定义deviceNode
3、HDF 框架初始化
4、解析HCS 文件，生成设备树
5、遍历设备树节点
6、根据moduleName 查找驱动对象 HdDriverEntry
7、调用驱动的Bind 方法
8、调用驱动的Init 方法
9、硬件初始化和注册服务，最后加载完成

总结：
1、配置先行：在HCS 文件中定义设备属性、与驱动代码通过moduleName 关联
2、框架管理：HDF 框架在初始化时解析HCS，生成设备树
3、动态加载：根据设备节点的加载策略，合适时机查找，并调用驱动代码中的Bind 和 Init函数
4、驱动工作： 驱动在Init函数中完成硬件初始化和接口注册。


```

HdfDeviceObject     hdf_core/interfaces/inner_api/host/shared/hdf_device_desc.h

关键结构体
```
HdfDeviceInfo:
HdfDeviceObject:
HdfDeviceNode：
DeviceNodeExt：

```


```

DeviceManagerStart  hdf_core/framework/core/common/src/devmgr_service_start.c

HdfIoServiceAdapterPublish  hdf_core/framework/core/adapter/vnode/src/hdf_vnode_adapter.c
HdfIoServiceAdapterRegCdev  同上

HdfVnodeAdapter    drivers/hdf_core/framework/core/adapter/vnode/include/hdf_vnode_adapter.h
DevmgrServiceStartService   hdf_core/framework/core/manager/src/devmgr_service.c
DevmgrServiceStartDeviceHost 同上

HdfAttributeManagerGetHostList   hdf_core/framework/core/common/src/hdf_attribute.c 
GetHdfManagerNode    同上
HcsGetNodeByMatchAttr   同上
DevmgrServiceStartDeviceHost   hdf_core/framework/core/manager/src/devmgr_service.c
DevmgrServiceStartHostProcess  同上

DriverInstallerConstruct   hdf_core/framework/core/manager/src/hdf_driver_installer.c
DriverInstallerStartDeviceHost 同上

DevHostServiceClntInstallDriver     drivers/hdf_core/framework/core/manager/src/devhost_service_clnt.c   
HdfDeviceInfo     hdf_core/interfaces/inner_api/host/shared/hdf_device_info.h    
DevHostServiceAddDevice    hdf_core/framework/core/host/src/devhost_service.c
DevHostServiceQueryOrAddDevice 同上
   
HdfDriverLoaderGetInstance   /hdf_core/framework/core/host/src/hdf_driver_loader.c      
HdfDriverLoaderCreate      同上
HdfDriverEntryConstruct    同上
HDF_INIT     hdf_core/interfaces/inner_api/host/shared/hdf_device_desc.h
HDF_DRIVER_INIT   hdf_core/interfaces/inner_api/host/uhdf/hdf_device_section.h
HdfRegisterDriverEntry   hdf_core/framework/core/manager/src/driver_manager.c
HdfDriver      hdf_core/interfaces/inner_api/host/shared/hdf_driver.h
GetDriver    
HdfDriverManagerGetDriver   hdf_core/framework/core/manager/src/driver_manager.c
HdfDriverManagerFoundDriver  同上

HdfDeviceLaunchNode     hdf_core/framework/core/host/src/hdf_device_node.c
DeviceDriverBind 同上
HdfDeviceNodePublishService  同上

DeviceNodeExtConstruct    hdf_core/framework/core/common/src/hdf_device_node_ext.c
DeviceNodeExt     hdf_core/framework/core/common/include/manager/hdf_device_node_ext.h
DeviceNodeExtPublishService   hdf_core/framework/core/common/src/hdf_device_node_ext.c


DevmgrServiceAttachDevice      hdf_core/framework/core/manager/src/devmgr_service.c
DeviceTokenClntNewInstance      drivers/hdf_core/framework/core/manager/src/device_token_clnt.c
HdfDeviceNodePublishLocalService     hdf_core/framework/core/host/src/hdf_device_node.c

HdfServiceObserverPublishService    hdf_core/framework/core/host/src/hdf_service_observer.c
DevmgrServiceClntAttachDevice       hdf_core/framework/core/host/src/devmgr_service_clnt.c
DevmgrServiceClntAttachDevice       hdf_core/framework/core/host/src/devmgr_service_clnt.c
DevmgrServiceAttachDevice       hdf_core/framework/core/manager/src/devmgr_service.c


代码地址








DeviceManagerStart: LiteOS 和 Linux 都会汇集到这里
1、创建 IDevmgrService *instance 对象
2、HdfIoServicePublic() 发布用户态devmgr服务
3、然后通过instance 去调用 StartService  这个是去启动内核态的devmgr


HdfIoServicePublic:
1、ioService 中的dispatcher 指向  DeviceManagerDispatch
2、

HdfIoServiceAdapterPublish：
1、创建HdfVnodeAdapter vnodeAdapter 对象
2、将vnodeAdapter 的NodePath 指向 /dev/hdf/dev_mgr
3、最后会去调用 HdfIoServiceAdapterRegCdev


HdfIoServiceAdapterRegCdev： 进行设备节点的绑定
1、绑定 vnodeAdapter 的cdev的文件操作
2、绑定驱动服务接口 返回 &vnodeAdapter->ioService


一、用户态devmgr服务的启动
HdfVnodeAdapter：
1、可以获取 HdfIoService 进而可以获取 DevmgrServices （也就是 IDevmgrService）、HdfIoDispatcher
2、也可以获取OsalCdev 从而获取OsalCdevOps
所以通过HdfVnodeAdapter 就能从用户态 到内核态的一个过渡



二、内核态devmgr服务的启动

DevmgrServiceStartService：
1、DevmgrServiceStartService 去调用 DevmgrServiceStartDeviceHosts 来启动host 
   
DevmgrServiceStartDeviceHosts：
 1、获取hostList：HdfAttributeManagerGetHostList-> GetHdfManagerNode->HcsGetNodeByMatchAttr->
 2、对hostList 遍历，并将节点取出来， 并调用DevmgrServiceStartDeviceHost 启动host
 3、
 
 
DevmgrServiceStartDeviceHost：
1、根据hostId,  hostName, 生成 DevHostServiceClnt hostClnt（每一个host 都对应一个它）
2、将 hostClnt 添加到链表尾部
3、调用DevmgrServiceStartHostProcess 去启动host
4、最后调用 DevHostServiceClntFreeInstance(hostClnt) 将hostClnt 删除


DevmgrServiceStartHostProcess：
1、通过DriverInstallerGetInstance 获取 IDriverInstaller
2、installer->StartDeviceHost 启动host
3、赋值相关属性给 DevHostServiceClnt

StartDeviceHost：
1、找到 DriverInstallerConstruct 里面会把 StartDeviceHost 的操作指向 DriverInstallerStartDeviceHost
2、还要进行DevmgrServiceAttachDeviceHost，也就是进行attch 的操作


DriverInstallerStartDeviceHost：
1、通过 DevHostServiceNewInstance 获取 IDevHostService *hostServiceIf 
2、然后通过hostServiceIf 调用 StartService 开启服务
3、最后把hostServiceIf 释放掉

```


设备加载流程 1
```
DevHostServiceClntInstallDriver：
1、传入的参数DevHostServiceClnt *hostClnt
2、通过 hostClnt 加载unloadDevInfos
3、迭代器进行迭代 获得每个对象是 HdfDeviceInfo devInfo；
4、判断设备需不需要启动 DEVICE_PRELOAD_DISABLE 这个是不需要加载的标识
5、需要启动的话，就往 hostClnt 的 hostService 中添加设备，添加方式调用AddDevice，AddDevice 的实现是 DevHostServiceAddDevice
6、最后改变deviceInfo 的状态为可用

HdfDeviceInfo：
deviceName
deviceMatchAttr
svcName

DevHostServiceAddDevice：
1、调用HdfDriverLoaderGetInstance 获取IDriverLoader *driverLoader 对象
2、接着 DevHostServiceQueryOrAddDevice 通过 deviceId 去找设备，并获取
3、再去通过super.GetDeviceNode 获取devNode（也就是device 的子节点）
4、通过 GetDriver 也就是 HdfDriverManagerGetDriver 去获取driver 
4、通过moduleName 去加载驱动
5、绑定devNode 的相关属性，包括将driver 绑定上去
6、通过Attach 也就是 HdfDdeviceAttach 将设备节点挂载上去

HdfDriverLoaderGetInstance：
1、内部会去调用 HdfObjectManagerGetObject，其中的create 指向 HdfDriverLoaderCreate，也就是真正的实现

HdfDriverLoaderCreate：
1、会去调用 HdfDriverEntryConstruct，也就是创建设备的驱动入口对象
2、再把HdfDriverLoader driverLoader 创建出来
3、这里头的判断处理，使得一旦创建过，下次就直接返回

HdfDriverEntryConstruct：
1、获取设备节点的数量（device，比如有两个部件，那么就是有两个驱动入口），通过末尾地址将开始地址
2、遍历从第一个entry的地址开始，将地址强转为driverEntry，递增地将所有entry 取出来。
3、取出来的entry 通过 HdfRegisterDriverEntry 将它注册到HDF框架中

HdfRegisterDriverEntry:
1、创建一个新的HdfDriver driver 对象
2、绑定entry
3、添加到链表里面去

HdfDriver：
HdfDriverEntry *entry
DListHead node


HDF_INIT：
1、#define HDF_INIT(module)  HDF_DRIVER_INIT(module)  所以真的实现是在 HDF_DRIVER_INIT

HDF_DRIVER_INIT
1、section 会去记录 entry 的地址 （.hdf.driver），编译的时候 将地址打到vmlinux.lds.S 文件中


DevHostServiceQueryOrAddDevice：
1、会通过 DevHostServiceFindDevice 去找设备
2、添加到链表中去 DevHostService 中的 devices 中去

GetDeviceNode：

GetDriver 实际是 HdfDriverManagerGetDriver：
1、HdfDriverManagerFoundDriver 通过 driverName，获取driver

HdfDriverManagerFoundDriver：
1、获取链表头部，然后根据driverName 判断是不是要找的驱动，如果是就返回


HdfDdeviceAttach：

1、获取devNode->token->devId
2、通过nodeIf 的 LanchNode(devNode) 完成驱动初始化

HdfDeviceLaunchNode:
1、先进行设备绑定 DeviceDriverBind
2、接下来是初始化 Init
3、然后是发布服务 HdfDeviceNodePublishService
4、挂载   DevmgrServiceClntAttachDevice

```

设备加载流程 2
```
主要是进行发布服务
HdfDeviceNodePublishService：
1、检查发布的状态，如果是1或者2 就是进行发布 PublishService 实际是 DeviceNodeExtConstruct() 中的 DeviceNodeExtPublishService
2、如果上面执行成功，会继续执行 HdfDeviceNodePublishLocalService


DeviceNodeExtConstruct:
1、传入参数 DeviceNodeExt *devnode
2、将nodeIf 的 PublishService 指向 DeviceNodeExtPublishService；
3、将nodeIf 的 RemoveService 指向 DeviceNodeExtRomoveService；


DeviceNodeExt：
HdfDeviceNode super;
HdfIoService *ioService;

DeviceNodeExtPublishService：
1、定义dispatch  也就是服务的执行函数 DeviceNodeExtDispatch   这个在用户态与内核态交互会详细分析
2、发布用户态服务   HdfIoServicePublish, 这里会进行判断，要不要发布
3、发布公共服务也就是内核态服务  HdfDeviceNodePublishPublicService

HdfIoServicePublish：


这里是发布公共服务
HdfDeviceNodePublishPublicService：
1、通过 DevSvcManagerClntAddService 获取 DevSvcManagerClnt 对象 最终访问 DevSvcManager 对象
2、将服务添加到DevSvcManager的 services 链表中去


DevmgrServiceAttachDevice:
1、 通过 DevmgrServiceFindDeviceHost  获取 hostClnt
2、 通过 DeviceTokenClntNewInstance 获取 DeviceTokenClnt tokenClnt 对象
3、 通过 HdfSListAdd 加到设备链表中，就说明开始工作了，并且收到host 的管理



DeviceTokenClnt：
HdfSListNode node    这是一个链表
IHdfDeviceToken *tokenIf
HdfDeviceInfo *deviceInfo

DeviceTokenClntNewInstance:

HdfDeviceNodePublishLocalService：
1、执行HdfServiceObserverPublishService

HdfServiceObserverPublishService：
1、先调用 HdfSListSearch 把匹配的观察者找出来 
2、如果没有找到，那么HdfServiceObserverRecordObtain 创建一个 HdfServiceObservedRecord serviceRecord 对象
3、将 devNode 相关信息 写到 serviceRecord 中 
4、这样就启动完毕了

DevmgrServiceClntAttachDevice:
1、调用 AttachDevice 实际上是 DevmgrServiceClntAttachDevice

DevmgrServiceClntAttachDevice:
1、通过调用 DevmgrServiceClntGetInstance 获取 DevmgrServiceClnt *inst 对象
2、接着通过 inst 获得 devMgrSvcIf
3、最后 devMgrSvcIf 调用 AttachDevice。也就是调用 DevmgrServiceAttachDevice

```


