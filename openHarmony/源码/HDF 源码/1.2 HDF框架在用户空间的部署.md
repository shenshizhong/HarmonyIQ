
HDF框架在用户空间的部署 (最主要是从hcs开始，然后增加了服务，以及通过ipc 通信)
```
===================以下是针对LiteOs-A 不涉及 ipc，直接进行调用=============
例子可以看 device/board/bearpi  或者 talkweb 或者 hisilicon
i2c_if：
I2cOpen
I2cClose
I2cTransfer

I2cOpen -> 调用 I2cCntlrGet -> I2cManagerFindCntlr


一、内核态
内核态的具体实现，直接去调用：

I2cManagerBind:
1、创建 manager， 实际就是 I2cManager，然后给他赋值
2、会去判断是否支持用户 LOSCFG_USER_I2C_SUPPORT、CONFIG_USER_I2C_SUPPORT
3、如果支持  
device->service = &manager->service;
device->service->Dispatch = I2cManagerDispatch;

3、g_i2cManager = manager，全局保存下来


I2cManager：
IDeviceIoService service
HdfDeviceObject *device


I2cManagerDispatch:
1、会根据 cmd 执行不同的操作 I2cManagerIoOpen、I2cManagerIoClose、I2cManagerIoTransfer


I2cManagerIoOpen:
1、会去调用 I2cCntlrGet 
2、调用 I2cManagerFindCntlr

I2cManagerIoClose：
1、最终调用 I2cCntlrPut


g_i2cManagerEntry = {
    .Bind = I2cManagerBind
}
HDF_INIT(g_i2cManagerEntry);



二、用户态

I2cOpen：
1、通过 I2cManagerGetService 先获得 I2cManagerService *i2cManager
2、调用 I2cHandleInstance 服务
3、再去调 HdfIoServiceDispatch



I2cManagerGetService：
1、先执行 HdfIoServiceBind

```

i2c_if              drivers/hdf_core/framework/support/platform/src/i2c/i2c_if.c
I2cOpen             同上
I2cCntlrGet         drivers/hdf_core/framework/support/platform/src/i2c/i2c_core.c
I2cManagerBind      同上
I2cManagerIoOpen   同上
I2cManagerIoClose   同上

I2cManagerGetService     drivers/hdf_core/framework/support/platform/src/i2c/i2c_if_u.c
HdfIoServiceBind         同上


===================以下是针对Linux 标准版  =============
注意：用户态的是不能直接调用内核的，而是需要代理
stub 可以理解成 服务端的对象的映射 也就是代理
```
用户态不是在同一个进程完成的 因为涉及 fork等
内核态是在同一个进程中完成的 

一、
BUILD.gn       drivers/hdf_core/adapter/uhdf2/manager/BUILD.gn
1、  defines = [ "__USER__" ]  进行宏定义
2、  ohos_executable("hdf_devmgr") 可以执行程序是 hdf_devmgr
3、  sources 包含 device_manager.c 入口程序
4、  ohos_prebuilt_etc("hdf_devmgr.cfg")  涉及到的配置文件，也就是启动的时候，来执行 hdf_devmgr

二、
BUILD.gn   drivers/hdf_core/adapter/uhdf2/host/BUILD.gn
1、ohos_executable("hdf_devhost") 也是可执行程序
2、devhost.c  包含main函数，所以是入口
3、通过 hdf_drvmgr 调用 fork(), 创建出子进程 来运行 hdf_devhost
4、最后再去调  ohos_shared_library("libhdf_host")

三、

用户态框架的大体加载流程
DevmgrService: 
1、StartService  会去启动 DevSvcManager
2、把 DevSvcManager 往 saManager 去注册
3、通过 AddService 把自己 DevmgrService 注册到  DevSvcManager
4、通过 DevHostServiceClnt 的 StartDeviceHosts 去 fork() host 服务
5、host 会通过 DevHostServiceStub、DeviceServiceStub 去管理驱动设备的请求
6、host 会去 saManager 获取 DevSvcManager
7、host 再去通过 DevSvcManager 获取 DevmgrService
8、通过 AttachDeviceHost 把 host 添加到 DevmgrService 管理的链表中去
9、通过 AddDevice 添加设备，也就是绑定驱动， 会执行 LoadDevice（）然后再去调用Bind Init
10、通过上面驱动就启动完毕，然后再通过 AttachDevice 将 驱动加到 DevmgrService 中 host 底下的设备链表


真正的实现流程：

用户态驱动框架的 hdf_devmgr 进程：
1、通电到系统内核启动完毕，OpenHarmony 进入用户态根进程 init 的启动阶段
2、init 会去解析 hdf_devmgr.cfg， 然后启动 hdf_devmgr
3、也就是会执行 device_manager.c 的入口程序，然后调用 main()

main:
1、通过 DevmgrServiceGetInstance 获取 IDevmgrService* instance 对象
2、调用 StartService 去启动 DevSvcManager
3、开启 DevmgrServiceStub 的消息循环 looper—> Start(looper);


DevmgrServiceGetInstance：
1、实际是调用 HdfObjectManagerGetObject

HdfObjectManagerGetObject：
1、HdfObjectManagerGetCreators   这个时候调的是用户态的代码

HdfObjectManagerGetCreators：
1、获取 g_fullDevMgrObjectCreators[0],也就是 .Create = DevmgrServiceStubCreate
2、

DevmgrServiceStubCreate：
1、通过 OsalMemCalloc 创建  DevmgrServiceStub *instance 对象
2、会去调用 DevmgrServiceStubConstruct

DevmgrServiceStubConstruct:  这块里头是递归调用的
1、将 inst 强制转换成 IDevmgrService
2、调用 DevmgrServiceFullConstruct  
3、然后将 pvtbl 的 StartService 赋值为 DevmgrServiceStubStartService
到这里

DevmgrServiceFullConstruct：
1、会去创建 DevmgrServiceFullDispatchMessage
1、会通过 HdfMessageLooperConstruct 去处理 looper 循环
2、会去调用 DevmgrServiceConstruct


DevmgrServiceFullDispatchMessage：处理消息队列
1、通过 DevmgrServiceGetInstance 获取 DevmgrServiceFull *fullService 对象
2、如果host 启动失败，会进行一些后续处理


StartService:  实际上是 DevmgrServiceStubStartService
DevmgrServiceStubStartService：
1、将 inst 强转为 DevmgrServiceStub *fullService
2、通过 DevSvcManagerGetInstance 创建 IDevSvcManager *serviceManager
3、通过 HdfRemoteServiceObtain 创建 HdfRemoteService *remoteService 远程服务
4、通过 DevSvcManagerAddService 将服务往 serviceManager 中添加
5、调用 DevmgrServiceStartService


DevSvcManagerGetInstance:
1、通过 HDF_OBJECT_ID_DEVSVC_MANAGER 这个id 从 HdfObjectManagerGetObject 去获取
HdfObjectManagerGetObject：
1、先 HdfObjectManagerGetCreators
2、实际是 DevSvcManagerStubCreate

DevSvcManagerStubCreate：
1、先执行 DevSvcManagerStubConstruct

DevSvcManagerStubConstruct：
1、先执行 DevSvcManagerConstruct(&inst->super) 也就是调父类的构造方法
2、将父类的 inst->super.super.StartService 改成 DevSvcManagerStubStart
3、



DevSvcManagerStubStart：(这个过程只是赋值，并不是真正的启动)
1、将 svcmgr 强转成 DevSvcManagerStub *inst
2、定义一个 DevSvcManagerStubDispatch 给外界访问的接口
3、通过 HdfRemoteServiceObtain 创建 一个远程服务对象 放到 DevSvcManagerStub *inst 桩对象
4、通过 HdfRemoteServiceRegister 注册前面的远程服务

DevSvcManagerStubDispatch：
1、根据 code  做不同的处理
2、重点关注 这么几个 code ：
DEVSVC_MANAGER_ADD_SERVICE  会去执行 DevSvcManagerStubAddService
DEVSVC_MANAGER_GET_SERVICE  会去执行 DevSvcManagerStubGetService
DEVSVC_MANAGER_REMOVE_SERVICE   会去执行 DevSvcManagerStubRemoveService

DevSvcManagerStubAddService：
1、将 super 强转成 DevSvcManagerStub *stub
2、调用父类的 AddService 也就是 IDevSvcManager 中的
3、最终执行 DevSvcManagerAddService

DevSvcManagerStubGetService：
1、将 super 强转成 DevSvcManagerStub *stub
2、通过 super 获取 HdfDeviceObject *serviceObject 
3、再通过 serviceObject 获取 HdfRemoteService *remoteService 服务

DevSvcManagerStubRemoveService：
1、通过 super 强转成 DevSvcManagerStub *stub
2、通过 super 的 GetObject 获取 HdfDeviceObject *serviceObject 
3、通过 RemoveService 将 serviceObject 移除


HdfRemoteServiceObtain：
1、通过 HdfRemoteAdapterObtain 获取  HdfRemoteService *service
2、将 dispatcher、object 给到服务

HdfRemoteServiceRegister：实际上调的是 HdfRemoteAdapterAddSa

HdfRemoteAdapterAddSa：
1、通过 GetSystemAbilityManager 获取 saManager
2、通过 saManager 的 AddSystemAbility 将服务添加，完成注册


DevSvcManagerAddService：
1、将 inst 强转成 DevSvcManager *devSvcManager 对象
2、OsalMutexLock 加锁
3、通过 DevSvcRecordNewInstance 创建一个 record
4、添加 record 的一些属性
5、最后通过 DListInsertTail 添加到链表尾部


DevmgrServiceStartService: 这里才是真正开启的地方
1、将 inst 强转成  DevmgrService *dmService 
2、通过 DevmgrServiceStartDeviceHosts 去启动一个个设备节点
3、


DevmgrServiceStartDeviceHosts：  //这里要注意最后带s 说明是遍历所有host，里头不带s是执行单个host
1、通过 HdfAttributeManagerGetHostList
2、迭代
3、DevmgrServiceStartDeviceHost
4、最后通过 HdfSListFlush 把临时链表删除

HdfAttributeManagerGetHostList：
1、通过 GetHdfManagerNode(HdfGetHcsRootNode()) 获取 DeviceResourceNode *hdfManagerNode
2、

GetHdfManagerNode：
1、会先执行 HdfGetHcsRootNode()

HdfGetHcsRootNode: （这边注意，用户态和内核态会产生分叉，主要是配置文件会不同,比如 moduleName 会是so包）
1、它访问的是 HOST_CONFIG_PATH  /system/etc/hdfconfig


DevmgrServiceStartDeviceHost：
1、通过 DevHostServiceClntNewInstance 获取  DevHostServiceClnt *hostClnt 对象
2、通过 DListInsertTail 将节点插入到链表尾部
3、最后执行 DevmgrServiceStartHostProcess
4、

DevmgrServiceStartHostProcess：
1、通过 DriverInstallerGetInstance 获取 IDriverInstaller *installer 对象
2、installer 执行 StartDeviceHost 去启动 host，并产生host id
3、host id 记录下来
4、

DriverInstallerGetInstance：
1、通过 HdfObjectManagerGetObject(HDF_OBJECT_ID_DRIVER_INSTALLER) 去获取 IDriverInstaller *installer 对象

HdfObjectManagerGetObject：
1、先 HdfObjectManagerGetCreators
2、实际是 DriverInstallerFullCreate

DriverInstallerFullCreate：
1、最终调用 DriverInstallerFullConstruct

StartDeviceHost：
1、最终是去执行 DriverInstallerFullConstruct

DriverInstallerFullConstruct：
1、给 StartDeviceHost 赋值为 DriverInstallerFullStartDeviceHost
2、给 StopDeviceHost 赋值为 DriverInstallerFullStopDeviceHost

DriverInstallerFullStartDeviceHost：
1、调用 ServiceControlWithExtra
2、

ServiceControlWithExtra：地址是在base///service_control.c下面
1、会去执行 StartProcess

StartProcess:
1、调用 SystemSetParameter 去启动





```

hdf_devmgr.cfg   drivers/hdf_core/adapter/uhdf2/manager/hdf_devmgr.cfg
devhost.c    drivers/hdf_core/adapter/uhdf2/host/devhost.c
hdf_object_manager     hdf_core/framework/core/shared/src/hdf_object_manager.c


DevmgrServiceGetInstance    drivers/hdf_core/adapter/uhdf2/manager/device_manager.c
HdfObjectManagerGetObject   hdf_core/framework/core/shared/src/hdf_object_manager.c
HdfObjectManagerGetCreators  drivers/hdf_core/adapter/uhdf2/manager/src/devmgr_object_config.c

DevmgrServiceStubCreate      drivers/hdf_core/adapter/uhdf2/manager/src/devmgr_service_stub.c
DevmgrServiceStubConstruct   同上
DevmgrServiceStubStartService 同上
DevmgrServiceFullConstruct    drivers/hdf_core/adapter/uhdf2/manager/src/devmgr_service_full.c
DevmgrServiceFullDispatchMessage  同上
DevmgrServiceStub        drivers/hdf_core/adapter/uhdf2/manager/include/devmgr_service_stub.h
DevSvcManagerGetInstance    hdf_core/framework/core/manager/src/devsvc_manager.c
DevSvcManagerStubCreate     hdf_core/adapter/uhdf2/manager/src/devsvc_manager_stub.c
DevSvcManagerStubConstruct   同上
DevSvcManagerStubStart       同上
HdfRemoteServiceObtain      hdf_core/adapter/uhdf2/ipc/src/hdf_remote_service.c

DevSvcManagerAddService     hdf_core/framework/core/manager/src/devsvc_manager.c
HdfRemoteServiceRegister    hdf_core/adapter/uhdf2/ipc/src/hdf_remote_service.c
HdfRemoteAdapterAddSa       hdf_core/adapter/uhdf2/ipc/src/hdf_remote_adapter.cpp
DevmgrServiceStartService   hdf_core/framework/core/manager/src/devmgr_service.c
DevmgrServiceStartDeviceHosts  同上
DevmgrServiceStartDeviceHost   同上
DevmgrServiceStartHostProcess  同上
DriverInstallerGetInstance     hdf_core/framework/core/manager/src/hdf_driver_installer.c
DriverInstallerFullCreate      hdf_core/adapter/uhdf2/manager/src/driver_installer_full.c
DriverInstallerFullConstruct   同上
DriverInstallerFullStartDeviceHost  同上
DevSvcManagerStubDispatch       hdf_core/adapter/uhdf2/manager/src/devsvc_manager_stub.c


HdfAttributeManagerGetHostList     hdf_core/framework/core/common/src/hdf_attribute.c
HdfGetHcsRootNode              hdf_core/adapter/uhdf2/shared/src/hcb_config_entry.c
IDevSvcManager                 hdf_core/framework/core/shared/include/devsvc_manager_if.h
DevSvcManagerStubAddService    hdf_core/adapter/uhdf2/manager/src/devsvc_manager_stub.c
DevSvcManagerStubGetService    同上
DevSvcManagerStubRemoveService 同上
